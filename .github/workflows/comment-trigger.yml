name: PR Comment Trigger

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  comment-triggered-echo:
    # PRã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã‚’å¯¾è±¡ã¨ã—ã€ç‰¹å®šã®ã‚³ãƒãƒ³ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      github.event.issue.pull_request && 
      (contains(github.event.comment.body, '/echo') || 
       contains(github.event.comment.body, '/test') ||
       contains(github.event.comment.body, '/deploy') ||
       contains(github.event.comment.body, '/simple-echo'))
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆå®Ÿè¡Œé–‹å§‹ï¼‰
        run: echo "ğŸ‘€ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ã—ã¾ã—ãŸ"

      - name: PRã®çŠ¶æ…‹ç¢ºèª
        id: pr-check
        run: |
          echo "PRç•ªå·: ${{ github.event.issue.number }}"
          echo "ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹: ${{ github.event.comment.body }}"
          echo "ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿è€…: ${{ github.event.comment.user.login }}"

      - name: Echoå®Ÿè¡Œï¼ˆ/echoã‚³ãƒãƒ³ãƒ‰ï¼‰
        if: contains(github.event.comment.body, '/echo')
        run: |
          echo "ğŸ¯ /echo ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼"
          echo "æŠ•ç¨¿è€…: ${{ github.event.comment.user.login }}"
          echo "PR #${{ github.event.issue.number }} ã§ã‚³ãƒ¡ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã—ãŸ"
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')"

      - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆ/testã‚³ãƒãƒ³ãƒ‰ï¼‰
        if: contains(github.event.comment.body, '/test')
        run: |
          echo "ğŸ§ª /test ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼"
          echo "ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®å®Ÿè¡Œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¦ã„ã¾ã™..."
          sleep 3
          echo "âœ… ãƒ†ã‚¹ãƒˆå®Œäº†"

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œï¼ˆ/deployã‚³ãƒãƒ³ãƒ‰ï¼‰
        if: contains(github.event.comment.body, '/deploy')
        run: |
          echo "ğŸš€ /deploy ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼"
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¦ã„ã¾ã™..."
          sleep 5
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

      - name: Simple Echoå®Ÿè¡Œï¼ˆ/simple-echoã‚³ãƒãƒ³ãƒ‰ï¼‰
        if: contains(github.event.comment.body, '/simple-echo')
        run: |
          echo "ğŸš€ GitHub Actions ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼"
          echo "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: Simple Echo from PR comment trigger"
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date)"
          echo "ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
          echo "PRç•ªå·: #${{ github.event.issue.number }}"
          echo "å®Ÿè¡Œè€…: ${{ github.event.comment.user.login }}"

      - name: çµæœã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number
            });

            const triggerComment = comments.find(comment => 
              comment.id === context.payload.comment.id
            );

            const success = '${{ job.status }}' === 'success';
            const workflowUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            let commandType = 'unknown';
            if (triggerComment.body.includes('/echo')) commandType = 'echo';
            else if (triggerComment.body.includes('/test')) commandType = 'test';
            else if (triggerComment.body.includes('/deploy')) commandType = 'deploy';
            else if (triggerComment.body.includes('/simple-echo')) commandType = 'simple-echo';

            const resultEmoji = success ? 'âœ…' : 'âŒ';
            const statusText = success ? 'æˆåŠŸ' : 'å¤±æ•—';

            const commentBody = `
            **ğŸ¤– GitHub Actions å®Ÿè¡Œçµæœ**

            - **ã‚³ãƒãƒ³ãƒ‰**: \`/${commandType}\`
            - **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${resultEmoji} ${statusText}
            - **å®Ÿè¡Œè€…**: @${{ github.event.comment.user.login }}
            - **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [${{ github.workflow }}](${workflowUrl})

            ${success ? 'å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚' : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'}
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: commentBody
            });

      - name: ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–°ï¼ˆå®Œäº†ï¼‰
        if: always()
        run: echo "âœ… ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†: ${{ job.status }}"
